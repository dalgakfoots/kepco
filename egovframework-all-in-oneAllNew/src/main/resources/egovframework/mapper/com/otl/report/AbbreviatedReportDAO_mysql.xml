<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="AbbreviatedReportDAO">

	<resultMap id="abbreviatedReportVO" type="egovframework.otl.report.service.AbbreviatedReportVO">
		<result property="trainId" column="training_id"/>
		<result property="teamId" column="team_id"/>
		<result property="reportId" column="report_id"/>
		<result property="reportStatus" column="report_status"/>
		<result property="reportType" column="report_type"/>
		<result property="reportTitle" column="report_title"/>
		<result property="reportContent" column="report_content"/>
		<result property="attachFileId" column="attach_file_id"/>
		<result property="createUserId" column="create_user_id"/>
		<result property="createdDateTime" column="created_datetime"/>
		<result property="updatedDateTime" column="updated_datetime"/>
	</resultMap>

	<!--SELECTS-->

	<select id="abbreviatedReportList" parameterType="java.util.HashMap" resultMap="abbreviatedReportVO">
		SELECT TRAINING_ID,
			   B.GROUP_NM AS TEAM_ID,
		       REPORT_ID,
			   REPORT_TYPE,
			   REPORT_TITLE,
			   REPORT_STATUS
		FROM   ABBR_REPORT_DETAIL A LEFT OUTER JOIN comtnauthorgroupinfo B ON A.TEAM_ID = B.GROUP_ID
		<choose>
			<when test="role == 'ROLE_ADMIN'">
				<choose>
					<when test="reportType == null or reportType == ''">
					WHERE REPORT_TYPE IN ('APT1','APT2','WEB','DDOS','RANSOM')
					</when>
					<when test="reportType != null and reportType != ''">
					WHERE REPORT_TYPE = #{reportType}
					</when>
				</choose>
				<if test="reportTitle != null and reportTitle != ''">
					AND REPORT_TITLE LIKE CONCAT('%',#{reportTitle},'%')
				</if>
				<if test="reportStatus != null and reportStatus != ''">
					AND REPORT_STATUS = #{reportStatus}
				</if>
				<if test="teamId != null and teamId != ''">
					AND B.GROUP_NM REGEXP #{teamId}
				</if>
			</when>
			<otherwise>
		WHERE  TEAM_ID = #{teamId}
			</otherwise>
		</choose>
		ORDER BY REPORT_ID DESC
		LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
	</select>

	<select id="abbreviatedReportCount" parameterType="java.util.HashMap" resultType="java.lang.Integer">
		SELECT COUNT(*)
		FROM   ABBR_REPORT_DETAIL A LEFT OUTER JOIN comtnauthorgroupinfo B ON A.TEAM_ID = B.GROUP_ID
		<choose>
			<when test="role == 'ROLE_ADMIN'">
				<choose>
					<when test="reportType == null or reportType == ''">
						WHERE REPORT_TYPE IN ('APT1','APT2','WEB','DDOS','RANSOM')
					</when>
					<when test="reportType != null and reportType != ''">
						WHERE REPORT_TYPE = #{reportType}
					</when>
				</choose>
				<if test="reportTitle != null and reportTitle != ''">
					AND REPORT_TITLE LIKE CONCAT('%',#{reportTitle},'%')
				</if>
				<if test="reportStatus != null and reportStatus != ''">
					AND REPORT_STATUS = #{reportStatus}
				</if>
				<if test="teamId != null and teamId != ''">
					AND B.GROUP_NM REGEXP #{teamId}
				</if>
			</when>
			<otherwise>
		WHERE  TEAM_ID = #{teamId}
			</otherwise>
		</choose>
	</select>

	<select id="abbreviatedReportDetail" parameterType="egovframework.otl.report.service.AbbreviatedReportVO" resultMap="abbreviatedReportVO">
		SELECT TRAINING_ID,
		       TEAM_ID,
		       REPORT_ID,
		       REPORT_TYPE,
		       REPORT_STATUS,
		       REPORT_TITLE,
			   REPLACE(REPLACE(REPLACE(REPORT_CONTENT, <![CDATA['&lt;']]> , <![CDATA['<']]>),<![CDATA['&quot;']]>,'"'),<![CDATA['&gt;']]>,<![CDATA['>']]>) AS REPORT_CONTENT,
		       ATTACH_FILE_ID
		  FROM ABBR_REPORT_DETAIL
		 WHERE REPORT_ID = #{reportId}
	</select>

	<select id="searchUsersTrainingAndTeamId" parameterType="String" resultMap="abbreviatedReportVO">
		SELECT a.ESNTL_ID AS CREATED_USER_ID,
		       b.TEAM_ID AS TEAM_ID,
			   c.TRAINING_ID AS TRAINING_ID
		FROM   COMTNGNRLMBER a
				   INNER JOIN KEPCO_TEAM_USERS b
							  ON a.ESNTL_ID = b.USER_ID
								  AND b.IS_ENABLED = 'Y'
				   INNER JOIN KEPCO_TRAINING_TEAM_VMGROUP c
							  ON b.TEAM_ID = c.TEAM_ID
		WHERE  ESNTL_ID = #{value}
	</select>

	<select id="searchTeamIdList" parameterType="String" resultType="java.util.HashMap">
		SELECT B.GROUP_NM AS TEAM_ID
		  FROM KEPCO_TRAINING_TEAM_VMGROUP A INNER JOIN COMTNAUTHORGROUPINFO B ON A.TEAM_ID = B.GROUP_ID
		 WHERE A.TRAINING_ID = #{value}
	</select>

	<!--INSERTS-->

	<insert id="abbreviatedReportInsert" parameterType="egovframework.otl.report.service.AbbreviatedReportVO">
		INSERT INTO ABBR_REPORT_DETAIL
					(
					 TRAINING_ID,
					 TEAM_ID,
					 REPORT_ID,
					 REPORT_STATUS,
					 REPORT_TYPE,
					 REPORT_TITLE,
					 REPORT_CONTENT,
					 ATTACH_FILE_ID,
					 CREATE_USER_ID
					 )
		VALUES(
		       #{trainId},
		       #{teamId},
		       #{reportId},
		       #{reportStatus},
		       #{reportType},
		       #{reportTitle},
		       #{reportContent},
		       #{attachFileId},
		       #{createUserId}
		       )
	</insert>

	<insert id="abbreviatedReportGiveScore" parameterType="java.util.HashMap">
		INSERT INTO KEPCO_TRAINING_TEAM_SCORES
					(
					 TRAINING_ID,
					 TEAM_ID,
					 QUESTION_ID,
					 SCORE_ID,
					 TRAINING_TYPE,
					 SCORE
					)
		VALUES(
		       #{trainingId},
		       #{teamId},
		       #{questionId},
		       #{scoreId},
		       #{trainingType},
		       #{score}
			  )
		ON DUPLICATE KEY UPDATE
					SCORE = #{score}
	</insert>

	<!--UPDATES-->
	<update id="abbreviatedReportSubmit" parameterType="egovframework.otl.report.service.AbbreviatedReportVO">
		UPDATE ABBR_REPORT_DETAIL
		SET    REPORT_STATUS = '200'
		WHERE  REPORT_ID = #{reportId}
	</update>

	<update id="abbreviatedReportChangeStatus" parameterType="egovframework.otl.report.service.AbbreviatedReportVO">
		UPDATE ABBR_REPORT_DETAIL
		SET    REPORT_STATUS = #{reportStatus}
		WHERE  REPORT_ID = #{reportId}
	</update>

	<update id="abbreviatedReportUpdate" parameterType="egovframework.otl.report.service.AbbreviatedReportVO">
		UPDATE ABBR_REPORT_DETAIL
		SET    REPORT_TYPE = #{reportType},
			   REPORT_TITLE = #{reportTitle},
			   REPORT_CONTENT = #{reportContent}
		       <if test="attachFileId != null">
			   ,ATTACH_FILE_ID = #{attachFileId}
			   </if>
		WHERE  REPORT_ID = #{reportId}
	</update>

	<!--DELETES-->

	<delete id="abbreviatedReportDelete" parameterType="egovframework.otl.report.service.AbbreviatedReportVO">
		DELETE FROM ABBR_REPORT_DETAIL
		WHERE  REPORT_ID = #{reportId}
	</delete>

	<delete id="abbreviatedReportUndoGiveScore" parameterType="egovframework.otl.report.service.AbbreviatedReportVO">
		DELETE FROM KEPCO_TRAINING_TEAM_SCORES
		WHERE  QUESTION_ID = #{reportId}
	</delete>

</mapper>