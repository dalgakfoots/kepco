<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="TrainMessageDAO">

	<resultMap id="trainMessageVO" type="egovframework.otl.message.service.TrainMessageVO">
		<result property="messageId" column="message_id"/>
		<result property="teamId" column="team_id"/>
		<result property="messageTitle" column="message_title"/>
		<result property="messageContent" column="message_content"/>
		<result property="createdUserId" column="created_user_id"/>
		<result property="createdDateTime" column="created_datetime"/>
		<result property="readCount" column="cnt"/>
	</resultMap>

	<!--SELECTS-->

	<select id="trainMessageList" parameterType="java.util.HashMap" resultMap="trainMessageVO">
		SELECT A.MESSAGE_ID,
		       A.MESSAGE_TITLE,
		       B.GROUP_NM AS TEAM_ID,
			   DATE_FORMAT(A.CREATED_DATETIME, '%Y.%m.%d %H:%i') as CREATED_DATETIME,
		       C.MBER_ID AS CREATED_USER_ID
			   <if test="role == 'ROLE_USER'">
			   ,IFNULL(D.CNT,0) as CNT
			   </if>
		  FROM TRAIN_MESSAGE_DETAIL A INNER JOIN comtnauthorgroupinfo B
		    ON A.TEAM_ID = B.GROUP_ID
		  LEFT OUTER JOIN COMTNGNRLMBER C ON A.CREATED_USER_ID = C.ESNTL_ID
		  <choose>
			  <when test="role == 'ROLE_ADMIN'">

			  </when>
			  <otherwise>
		  LEFT OUTER JOIN (SELECT MESSAGE_ID, USER_ID, COUNT(*) AS CNT
		      				 FROM USER_MESSAGE_CHECK
		      				GROUP BY MESSAGE_ID , USER_ID) D ON A.MESSAGE_ID = D.MESSAGE_ID
		                                      AND D.USER_ID = #{esntlId}
		 WHERE A.TEAM_ID = #{teamId}
			  </otherwise>
		  </choose>
		  ORDER BY CREATED_DATETIME DESC
		  LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
	</select>

	<select id="trainMessageDetail" parameterType="egovframework.otl.message.service.TrainMessageVO" resultMap="trainMessageVO">
		SELECT MESSAGE_ID,
		       MESSAGE_TITLE,
		       MESSAGE_CONTENT
		  FROM TRAIN_MESSAGE_DETAIL
		 WHERE MESSAGE_ID = #{messageId}
	</select>

	<select id="trainMessageListCount" parameterType="java.util.HashMap" resultType="java.lang.Integer">
		SELECT COUNT(*)
		FROM TRAIN_MESSAGE_DETAIL A INNER JOIN comtnauthorgroupinfo B
		ON A.TEAM_ID = B.GROUP_ID
		<choose>
			<when test="role == 'ROLE_ADMIN'">

			</when>
			<otherwise>
		WHERE A.TEAM_ID = #{teamId}
			</otherwise>
		</choose>
	</select>

	<select id="searchTeamIdList" parameterType="String" resultType="java.util.HashMap">
		SELECT B.GROUP_ID AS TEAM_ID,
		       B.GROUP_NM AS TEAM_NM
		FROM KEPCO_TRAINING_TEAM_VMGROUP A INNER JOIN COMTNAUTHORGROUPINFO B ON A.TEAM_ID = B.GROUP_ID
		WHERE A.TRAINING_ID = #{value}
	</select>

	<select id="searchUsersTeamId" parameterType="String" resultMap="trainMessageVO">
		SELECT b.TEAM_ID AS TEAM_ID
		FROM   COMTNGNRLMBER a
				   INNER JOIN KEPCO_TEAM_USERS b
							  ON a.ESNTL_ID = b.USER_ID
								  AND b.IS_ENABLED = 'Y'
				   INNER JOIN KEPCO_TRAINING_TEAM_VMGROUP c
							  ON b.TEAM_ID = c.TEAM_ID
		WHERE  ESNTL_ID = #{value}
	</select>

	<!--INSERTS-->

	<insert id="trainMessageSubmit" parameterType="egovframework.otl.message.service.TrainMessageVO">
		INSERT INTO TRAIN_MESSAGE_DETAIL
					(MESSAGE_ID,
					 TEAM_ID,
					 MESSAGE_TITLE,
					 MESSAGE_CONTENT,
					 CREATED_USER_ID)
			 VALUES (
			         #{messageId},
			         #{teamId},
			         #{messageTitle},
			         #{messageContent},
			         #{createdUserId}
					)
	</insert>

	<insert id="userMessageCheck" parameterType="java.util.HashMap">
		INSERT INTO USER_MESSAGE_CHECK
					(
					 MESSAGE_ID,
					 USER_ID
					 )
			 VALUES (
			         #{messageId},
			         #{userId}
					)
	</insert>

</mapper>