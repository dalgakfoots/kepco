<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="groupManageDAO">

	<resultMap id="group" type="egovframework.com.sec.gmt.service.GroupManageVO">
        <result property="groupId" column="GROUP_ID"/>
		<result property="groupNm" column="GROUP_NM"/>
		<result property="groupDc" column="GROUP_DC"/>
        <result property="groupCreatDe" column="GROUP_CREAT_DE"/>
	</resultMap>
	
 	<resultMap id="vmType" type="egovframework.com.sec.gmt.service.VmTypeVO">
        <result property="id" column="id"/>
		<result property="type" column="type"/>
        <result property="createdDatetime" column="created_datetime"/>
	</resultMap>
	

    <select id="selectGroup" parameterType="egovframework.com.sec.gmt.service.GroupManageVO" resultMap="group">
        
            SELECT GROUP_ID, GROUP_NM, GROUP_DC, GROUP_CREAT_DE
              FROM COMTNAUTHORGROUPINFO 
             WHERE GROUP_ID=#{groupId}
        
    </select>

    <select id="selectGroupList" parameterType="egovframework.com.sec.gmt.service.GroupManageVO" resultMap="group">

            SELECT GROUP_ID, GROUP_NM, GROUP_DC, GROUP_CREAT_DE
              FROM COMTNAUTHORGROUPINFO
             WHERE 1=1
            <if test="searchCondition == 1">AND
                GROUP_NM LIKE CONCAT('%' , #{searchKeyword}, '%')
            </if>
            ORDER BY GROUP_CREAT_DE DESC
            LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
    </select>
    
    <select id="selectGroupListKepco" parameterType="egovframework.com.sec.gmt.service.GroupManageVO" resultMap="group">

            SELECT GROUP_ID, GROUP_NM, GROUP_DC, GROUP_CREAT_DE
              FROM COMTNAUTHORGROUPINFO
             WHERE 1=1
    </select>
	
	<select id="selectUsers" parameterType="egovframework.com.sec.gmt.service.GroupManageVO" resultType="java.util.HashMap">
		SELECT A.TEAM_ID,
			   A.USER_ID,
			   B.MBER_ID,
			   B.MBER_NM,
			   A.IS_ENABLED
		  FROM KEPCO_TEAM_USERS A LEFT OUTER JOIN COMTNGNRLMBER B 
		    ON A.USER_ID = B.ESNTL_ID
		 WHERE TEAM_ID = #{groupId}
	</select>
	
	<!-- 훈련 매핑관리에서 사용  -->
	<select id="selectTrainGroupVmList" resultType="java.util.HashMap">
		SELECT ID,
			   TRAINING_ID,
			   TEAM_ID,
			   PST_VM_ID,
			   PST_EXAM_GROUP_ID,
			   MDT_VM_ID,
			   MDT_EXAM_GROUP_ID,
			   WAT_VM_ID,
			   WAT_EXAM_GROUP_ID,
			   AST_VM_ID,
			   AST_EXAM_GROUP_ID
	      FROM KEPCO_TRAINING_TEAM_VMGROUP
		LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
	</select>
	
	<select id="selectVmGroupListForMapping" resultType="java.util.HashMap">
		SELECT ID,
			   NAME
		  FROM kepco_vm_groups
	</select>
	
	<select id="selectTrainList" resultType="java.util.HashMap">
		SELECT EVENT_ID,
			   EVENT_CN,
			   EVENT_SVC_BGNDE,
			   EVENT_SVC_ENDDE
  		  FROM COMTNEVENTINFO
	</select>
	
	<select id="selectTeamList" resultType="java.util.HashMap">
		SELECT GROUP_ID,
			   GROUP_NM
		  FROM COMTNAUTHORGROUPINFO
	</select>
	
	<select id="selectExamGroupList" resultType="java.util.HashMap">
		SELECT FAQ_GROUP_ID,
			   FAQ_GROUP_NM,
			   FAQ_GROUP_DC,
			   `TYPE`
		  FROM KEPCO_EXAM_GROUP
	</select>
	
	<!-- 훈련 매핑관리에서 사용 끝 -->
	
	<insert id="insertGroup">
		
			INSERT INTO COMTNAUTHORGROUPINFO 
				  ( GROUP_ID
				  , GROUP_NM
				  , GROUP_DC
				  , GROUP_CREAT_DE )
		   VALUES ( #{groupId}
			      , #{groupNm}
				  , #{groupDc}
				  , now())
		
	</insert>
	
	<insert id="insertUserGroupMapping">
			INSERT INTO KEPCO_TEAM_USERS
				  (TEAM_ID,
				  USER_ID,
				  IS_ENABLED
				  )
			VALUES (#{groupId},
					#{userId},
					'Y'
					)
	
	</insert>
	
	<update id="updateGroup" parameterType="egovframework.com.sec.gmt.service.GroupManage">
		
			UPDATE COMTNAUTHORGROUPINFO 
			   SET GROUP_NM=#{groupNm}
				 , GROUP_DC=#{groupDc}
				 , GROUP_CREAT_DE=now()
		  	 WHERE GROUP_ID=#{groupId}
		
	</update>
	
	<update id="updateUserGroupId">
			UPDATE COMTNGNRLMBER
			   <choose>
				   <when test='groupId == ""'>
				   SET GROUP_ID = NULL
				   </when>
				   <otherwise>
				   SET GROUP_ID = #{groupId}   
				   </otherwise>
			   </choose>
			 WHERE ESNTL_ID = #{userId}
	</update>
	
	<update id="updateTrainGroupVmManage">
			UPDATE KEPCO_TRAINING_TEAM_VMGROUP
			   SET TRAINING_ID = #{training_id},
			   	   TEAM_ID = #{team_id},
			   	   PST_VM_ID = #{pstVmGroupId},
			   	   PST_EXAM_GROUP_ID = #{pstExamGroupId},
			   	   MDT_VM_ID = #{mdtVmGroupId},
			   	   MDT_EXAM_GROUP_ID = #{mdtExamGroupId},
			   	   WAT_VM_ID = #{watVmGroupId},
			   	   WAT_EXAM_GROUP_ID = #{watExamGroupId},
			   	   AST_VM_ID = #{astVmGroupId},
			   	   AST_EXAM_GROUP_ID = #{astExamGroupId}
			 WHERE ID = #{id}
	</update>
	
	
	<delete id="deleteGroup">
		
			DELETE FROM COMTNAUTHORGROUPINFO 
			 WHERE GROUP_ID=#{groupId}
		
	</delete>
	
	<delete id="deleteUserGroupMapping">
			DELETE FROM KEPCO_TEAM_USERS
			 WHERE TEAM_ID = #{teamId}
	</delete>
	
	<delete id="deleteTrainGroupVmManage">
			DELETE FROM KEPCO_TRAINING_TEAM_VMGROUP
			 WHERE ID = #{id}
	</delete>
	
	<select id="selectGroupListTotCnt" parameterType="egovframework.com.sec.gmt.service.GroupManageVO" resultType="int">

			SELECT COUNT(*) totcnt
			FROM COMTNAUTHORGROUPINFO
			WHERE 1=1
			<if test="searchCondition == 1">AND
				GROUP_NM LIKE CONCAT('%' , #{searchKeyword}, '%')
			</if>
	</select>
	
	<select id="selectVmGroupTypeList" parameterType="egovframework.com.sec.gmt.service.GroupManageVO" resultType="java.util.HashMap">
			SELECT 
					vgt.vm_group_id,
			        vgt.vm_type_id,
			        vt.type,
			        vgt.vm_group_type_id,
			        vgt.name,
			       	vgt.id,
			        vgt.url,
			        vgt.ip,
			        vgt.user_name,
			        vgt.user_password,
			        vgt.created_datetime
			FROM kepco_vm_group_types vgt
			INNER JOIN kepco_vm_types vt on vt.id = vgt.vm_type_id
			WHERE vm_group_id = #{groupId};
	</select>
	
	<select id="selectTrainGroupVmListTotCnt" resultType="int">
		
		SELECT COUNT(*) totcnt
		  FROM KEPCO_TRAINING_TEAM_VMGROUP
		 WHERE 1=1
	</select>
	
	<insert id="insertTrainGroupVmManage">
		INSERT INTO KEPCO_TRAINING_TEAM_VMGROUP
			   		(ID,
			   		 TRAINING_ID,
			   		 TEAM_ID,
			   		 PST_VM_ID,
			   		 PST_EXAM_GROUP_ID,
			   		 MDT_VM_ID,
			   		 MDT_EXAM_GROUP_ID,
			   		 WAT_VM_ID,
			   		 WAT_EXAM_GROUP_ID,
			   		 AST_VM_ID,
			   		 AST_EXAM_GROUP_ID
			 		)VALUES(
			   		 #{id},
			   		 #{training_id},
			   		 #{team_id},
			   		 #{pstVmGroupId},
			   		 #{pstExamGroupId},
			   		 #{mdtVmGroupId},
			   		 #{mdtExamGroupId},
			   		 #{watVmGroupId},
			   		 #{watExamGroupId},
			   		 #{astVmGroupId},
			   		 #{astExamGroupId}
			   		)
	</insert>
	
	
	<insert id="insertVmGroup">
		INSERT INTO kepco_vm_groups ( 
			name,
			comment 
		) VALUES ( 
		   	#{groupNm},
		   	#{groupDc}
		)
		 <selectKey keyProperty="groupId" resultType="String">
            SELECT LAST_INSERT_ID()
        </selectKey>
	</insert>
	
	<select id="selectVmGroup" parameterType="egovframework.com.sec.gmt.service.GroupManageVO" resultMap="group">
            SELECT 
            	id as GROUP_ID, 
            	name as GROUP_NM, 
            	comment as GROUP_DC, 
            	created_datetime as GROUP_CREAT_DE
              FROM kepco_vm_groups 
             WHERE id=#{groupId}
        
    </select>
    
    <select id="selectVmGroupList" parameterType="egovframework.com.sec.gmt.service.GroupManageVO" resultMap="group">
            SELECT 
				id as GROUP_ID, 
            	name as GROUP_NM, 
            	comment as GROUP_DC, 
            	created_datetime as GROUP_CREAT_DE
              FROM kepco_vm_groups
             WHERE 1=1
            <if test="searchKeyword!=null or searchKeyword!=''">AND
                name LIKE CONCAT('%' , #{searchKeyword}, '%')
            </if>
            ORDER BY created_datetime DESC
            LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
    </select>
    
    <select id="selectVmGroupListTotCnt" parameterType="egovframework.com.sec.gmt.service.GroupManageVO" resultType="int">
			SELECT COUNT(*) totcnt
			FROM kepco_vm_groups
			WHERE 1=1
			<if test="searchKeyword!=null or searchKeyword!=''">AND
				name LIKE CONCAT('%' , #{searchKeyword}, '%')
			</if>
	</select>
	
	<delete id="deleteVmGroup">
			DELETE FROM kepco_vm_groups 
			 WHERE id=#{groupId}
	</delete>
	
	<update id="updateVmGroup" parameterType="egovframework.com.sec.gmt.service.GroupManage">
		
			UPDATE kepco_vm_groups 
			   SET name=#{groupNm}
				 , comment=#{groupDc}
				 , updated_datetime=now()
		  	 WHERE id=#{groupId}
		
	</update>
	
	<select id="selectVmTypeList" parameterType="egovframework.com.sec.gmt.service.VmTypeVO" resultMap="vmType">
		SELECT 
				id,
				type,
				created_datetime
		FROM kepco_vm_types
	</select>
	<select id="selectVmTypeList2" resultType="java.util.HashMap">
		SELECT 
				id,
				type,
				created_datetime
		FROM kepco_vm_types
	</select>
	
	<select id="selectVmTypeIdByVmType" parameterType="String" resultType="int" >
			SELECT 
				id
			FROM kepco_vm_types
			WHERE type=#{value}
	</select>
	
	<select id="selectSelectedTeamUsers" resultType="java.util.HashMap">
			
			SELECT MBER_ID,
				   MBER_NM,
				   ESNTL_ID,
				   GROUP_ID
			  FROM COMTNGNRLMBER
			 WHERE GROUP_ID = #{teamId}
			
	</select>
	
	<insert id="insertVmGroupTypes" parameterType="java.util.HashMap" >
		<selectKey keyProperty="vmGroupTypeId" resultType="String" order="BEFORE">
            SELECT 
            	(IFNULL(MAX(vm_group_type_id), 0) + 1) AS vm_group_type_id 
            FROM kepco_vm_group_types 
	            WHERE vm_group_id = #{groupId} 
	            AND vm_type_id = #{typeId}
        </selectKey>
	
			INSERT INTO kepco_vm_group_types (
				vm_group_id,
				vm_type_id,
				vm_group_type_id,
	            <if test="system!=null or system!=''">
	                name,
	            </if>
	            <if test="ip!=null or ip!=''">
	                ip,
	            </if>
	            <if test="userName!=null or userName!=''">
	                user_name,
	            </if>
	            <if test="userPW!=null or userPW!=''">
	                user_password,
	            </if>
				url,
				id
			) VALUES(
				#{groupId},
				#{typeId},
				#{vmGroupTypeId},
				<if test="system!=null or system!=''">
	                #{system},
	            </if>
	            <if test="ip!=null or ip!=''">
	                #{ip},
	            </if>
	            <if test="userName!=null or userName!=''">
	                #{userName},
	            </if>
	            <if test="userPW!=null or userPW!=''">
	                #{userPW},
	            </if>
				#{url},
				#{id}
			)
			
	
	</insert>
	
	<delete id="deleteVmGroupTypes" parameterType="egovframework.com.sec.gmt.service.GroupManage" >
			DELETE FROM kepco_vm_group_types 
			WHERE vm_group_id = #{groupId}
	</delete>
	
	
</mapper>